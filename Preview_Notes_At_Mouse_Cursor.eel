// based on EEL script 6.9.2014 by spk77

// Link to forum post by kuus0 https://forum.cockos.com/showthread.php?t=146114


// ----- DEBUGGING ====>
@import ../X-Raym Scripts/Functions/X-Raym_Functions - console debug messages.eel

debug = 1; // 0 => No console. 1 => Display console messages for debugging.
clean = 1; // 0 => No console cleaning before every script execution. 1 => Console cleaning before every script execution.

msg_clean();
// <==== DEBUGGING -----


thread_search_buffer = 300;

function preview_notes_under_edit_cursor() local(take, note_count, break, index, start_pos)
(
  msg_s("Preview notes under edit cursor called");
  buf = 10000;
  (take = MIDIEditor_GetTake(MIDIEditor_GetActive())) ? (
    MIDI_CountEvts(take, note_count, 0, 0);
    index = 0;
    off = 1;
    extension_api("BR_GetMouseCursorContext", #window, #segment, #details, char_sz);
    cursor_pos = extension_api("BR_GetMouseCursorContext_Position");
    //cursor_pos = MIDI_GetPPQPosFromProjTime(take, pos);
    break = 0;
    while(break === 0 && index < note_count) (
		MIDI_GetNote(take, index, sel, muted, start_pos, end_pos, chan, pitch, velOut);
		(MIDI_GetProjTimeFromPPQPos(take, start_pos) > cursor_pos) ? (
				break = 1;
			):
			(
				(MIDI_GetProjTimeFromPPQPos(take, end_pos) > cursor_pos) ? (
					buf[off] = chan;
					buf[off+1] = pitch;
					buf[off+2] = velOut;
					off += 3;
				);
			); 
      index += 1;
    );
    
    buf_len = off - 1;
    buf[0] = buf_len;
    i = 1;
    loop(buf_len / 3,
      StuffMIDIMessage(0, 144 + buf[i], buf[i + 1], buf[i + 2]);
      i += 3;
    );
	

    SetExtState("note_preview", script_thread, "Night", false);
  );
);

function send_note_offs() (
  msg_s("Note offs called");
    buf = 10000;
	buf_len = buf[0];
	i = 1;
    loop(buf_len / 3,
      StuffMIDIMessage(0, 128 + buf[i], buf[i + 1],0);
      i += 3;
    );
);

function maybe_stop_notes() (
	stop_time = (9000)[0];
	time_precise(cur_time);
	(stop_time > cur_time) ? (
	defer("maybe_stop_notes();");
	):
	(send_note_offs());
);

//isplaying = GetToggleCommandStateEx(1, 1007);


function delet_ext_states() local(one)
(
  one = 0;
  loop(thread_search_buffer,
    DeleteExtState("note_preview", one, true);
    one += 1;
  );
);

function alternatesleep(ms) (
  ms /= 1000;
  next_script_thread = script_thread+1;
  break_loop = 0;
  msg_f(time_precise() - starttime);
  (time_precise() - starttime > ms) ? (
    // Wait 300ms
    msg_s("This should appear after 300ms");
    (HasExtState("note_preview", next_script_thread) || isitplaying != 0) ? (
      // Another script has been started or reaper is playing
      DeleteExtState("note_preview", script_thread, true);
    ):(
      send_note_offs();
      DeleteExtState("note_preview", script_thread, true);
      msg_s("Note-offs sent");
    );
    break_loop = 1;
  );

  break_loop == 0 ? (
    // Continue loop
    runloop("alternatesleep(thread_search_buffer)");
  );
);

starttime = time_precise();

isitplaying = GetPlayState();
playingbool = false;
(isitplaying != 0) ? (
  playingbool = true;
  //ShowConsoleMsg("playingbool");
  msg_f(isitplaying);
  // 1 is for when playing, 0 when nothing is happening
);

script_thread = 0;
script_thread_iter = 0;
loop(thread_search_buffer,
  HasExtState("note_preview", scriptthreaditer) ? (
    script_thread = scriptthreaditer + 1;
    msg_f(scriptthreaditer);
  );
  scriptthreaditer += 1;
);
msg_f(script_thread);

(isitplaying != 0) ? (
  // REAPER is playing rn
  response_to_messagebox = ShowMessageBox("REAPER is currently playing", "Preview notes script", 0);
):(
  // REAPER isn't playing
  HasExtState("note_preview", script_thread-1) ? (
    // REAPER isn't playing and previous script is still running
    msg_s("REAPER isn't playing and previous script is still running");
    send_note_offs();
    preview_notes_under_edit_cursor();
    alternatesleep(thread_search_buffer);
  ):(
    msg_s("REAPER isn't playing and no scripts running");
    send_note_offs();
    preview_notes_under_edit_cursor(thread_search_buffer);
    alternatesleep(thread_search_buffer);
  );
);






















/*


(isitplaying == 1 || isitplaying == 4) ? (
  // The project is currently playing
  delet_ext_states();
):(
  

  preview_notes_under_edit_cursor();

  //time_precise(cur_time);
  //(9000)[0] = cur_time + 0.3;
  //maybe_stop_notes();

  alternatesleep(300);
  (HasExtState("note_preview", script_thread)) ? (
    (isitplaying == 1 | isitplaying == 4) ? (
      // The project is currently playing
      DeleteExtState("note_preview", script_thread, true);
    ):(
      send_note_offs();
      DeleteExtState("note_preview", script_thread, true);
    );

  );
)

*/